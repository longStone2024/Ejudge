<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOJOJ - 提交代码</title>
    <script>
        // 检查登录状态
        function checkLoginStatus() {
            const token = localStorage.getItem('token');
            if (token) {
                // 验证token
                fetch('/api/verifyuser', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.msg === 'success') {
                        document.getElementById('user-info').style.display = 'block';
                        document.getElementById('username-display').textContent = data.username;
                    } else {
                        localStorage.removeItem('token');
                        document.getElementById('login-section').style.display = 'block';
                        document.getElementById('user-info').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('验证失败:', error);
                    localStorage.removeItem('token');
                    document.getElementById('user-info').style.display = 'none';
                });
            } else {
                document.getElementById('user-info').style.display = 'none';
            }
        }

        // 提交代码
        function submitCode() {
            const problemId = document.getElementById('problem-id').value;
            const language = document.getElementById('language').value;
            const code = document.getElementById('code').value;
            const token = localStorage.getItem('token');

            if (!problemId) {
                alert('请输入题目ID');
                return false;
            }

            if (!code.trim()) {
                alert('代码不能为空');
                return false;
            }
            
            alert('正在提交，可能需要一定时间');
            fetch('/api/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token
                },
                body: JSON.stringify({
                    pid: problemId,
                    lang: language,
                    code: code
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.msg === 'success') {
                    // 可以跳转到评测结果页面
                    window.location.href = '/status';
                } else {
                    alert('提交失败: ' + data.msg);
                }
            })
            .catch(error => {
                console.error('提交失败:', error);
                alert('提交失败，请重试');
            });
            return false;
        }

        // 页面加载完成后执行
        window.onload = function() {
            checkLoginStatus();
            // 如果URL中有problem参数，自动填充
            const urlParams = new URLSearchParams(window.location.search);
            const problemId = urlParams.get('problem');
            if (problemId) {
                document.getElementById('problem-id').value = problemId;
            }
        };
    </script>    <style>
        .danger-btn {
            background-color: #dc3545;  
            color: #fff;
            border: none;
            padding: 5px 5px;
            border-radius: 5px;
            cursor: pointer;
        }        
        .danger-btn:hover {
            background-color: #c82333;  
            color: #fff;
            border: none;
            padding: 5px 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .primary-btn {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 5px 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .primary-btn {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 5px 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .primary-btn:hover {
            background-color: #0056b3;
            color: #fff;
            border: none;
            padding: 5px 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .warning-btn {
            background-color: #ffc107;
            color: #fff;
            border: none;
            padding: 5px 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .warning-btn:hover {
            background-color: #e0a800;
            color: #fff;
            border: none;
            padding: 5px 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .success-btn {
            background-color: #28a745;
            color: #fff;
            border: none;
            padding: 5px 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .success-btn:hover {
            background-color: #218838;
            color: #fff;
            border: none;
            padding: 5px 5px;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- 顶部导航 - 与home.html保持一致 -->
    <header style="background: linear-gradient(to bottom, #ebf1f6 0%,#abd3ee 50%,#89c3eb 51%,#d5ebfb 100%);height: 50px;">
        <div style="display: inline-block;line-height: 50px;"><a href="/home">主页</a></div>
        <div style="display: inline-block; margin-left: 20px;line-height: 50px;"><a href="/problemset">题目列表</a></div>
        <div style="display: inline-block; margin-left: 20px;line-height: 50px;">提交代码</div>
        <div style="display: inline-block; margin-left: 20px;line-height: 50px;"><a href="/status">评测查询</a></div>
    </header>

    <!-- 用户信息 -->
    <div id="user-info" style="display: none;">
        <p>您已登录，用户名: <span id="username-display"></span></p>
        <button class="primary-btn" onclick="window.location.href = '/user/' + document.getElementById('username-display').textContent;">我的主页</button>
        <button class="danger-btn"  onclick="localStorage.removeItem('token'); checkLoginStatus();">退出登录</button>
    </div>

    <!-- 提交代码表单 -->
    <section id="submit-form" style="margin: 20px;">
        <h2>提交代码</h2>
        <form onsubmit="return submitCode()">
            <div style="margin-bottom: 10px;">
                <label for="problem-id">题目ID:</label>
                <input type="text" id="problem-id" name="problem-id" placeholder="输入题目ID">
            </div>
            <div style="margin-bottom: 10px;">
                <label for="language">编程语言:</label>
                <select id="language" name="language">
                    <option value="C">C</option>
                    <option value="C With O2">C With O2</option>
                    <option value="C++">C++</option>
                    <option value="C++ With O2">C++ With O2</option>
                    <option value="C++ 17">C++ 17</option>
                    <option value="C++ 17 With O2">C++ 17 With O2</option>
                    <option value="C++ 20">C++ 20</option>
                    <option value="C++ 20 With O2">C++ 20 With O2</option>
                    <option value="Java">Java</option>
                    <option value="Python2">Python2</option>
                    <option value="Python3">Python3</option>
                    <option value="Golang">Golang</option>
                    <option value="C#">C#</option>
                    <option value="PHP">PHP</option>
                    <option value="PyPy2">PyPy2</option>
                    <option value="PyPy3">PyPy3</option>
                    <option value="JavaScript Node">JavaScript Node</option>
                    <option value="JavaScript V8">JavaScript V8</option>
                    <option value="Ruby">Ruby</option>
                    <option value="Rust">Rust</option>
                </select>
            </div>
            <div style="margin-bottom: 10px;">
                <label for="code">代码:</label>
                <textarea id="code" name="code" rows="20" cols="80" placeholder="输入您的代码"></textarea>
            </div>
            <button class="primary-btn" type="submit">提交代码</button>
        </form>
    </section>
</body>
</html>