<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOJOJ - 用户管理</title>
    <script>
        // 检查登录状态
        function checkLoginStatus() {
            const token = localStorage.getItem('token');
            if (token) {
                // 验证token
                fetch('/api/admin/verifyuser', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.msg === 'success') {
                        document.getElementById('user-info').style.display = 'block';
                        // 显示用户名
                        document.getElementById('username-display').textContent = data.username;
                        document.getElementById('role-display').textContent = data.role;
                    } else {
                        localStorage.removeItem('token');
                        document.getElementById('user-info').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('验证失败:', error);
                    localStorage.removeItem('token');
                    document.getElementById('user-info').style.display = 'none';
                });
            } else {
                document.getElementById('user-info').style.display = 'none';
            }
        }        
        // 删除用户
        function deleteUser(uid) {
            const token = localStorage.getItem('token');
            fetch('/api/admin/deleteuser', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token
                },
                body: JSON.stringify({uid:uid})
            })
            .then(response => response.json())
            .then(data => {
                if (data.msg === 'success') {
                    // 删除成功后刷新用户列表
                    loadUsers();
                } else {
                    console.error('删除失败:', data.msg);
                }
            })
            .catch(error => {
                console.error('删除失败:', error);
            });
        }
        // 确认删除用户
        function confirmDelete(uid) {
            document.getElementById('delete-uid').textContent = uid;
            document.getElementById('delete-dialog').showModal();
        }
        // 关闭删除确认对话框
        function closeDeleteDialog() {
            document.getElementById('delete-dialog').close();
        }
        // 加载用户数据
        function loadUsers() {
            const token = localStorage.getItem('token');
            fetch('/api/admin/users?count=' + document.getElementById('count').value + '&page=' + document.getElementById('page').value,
            {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token
                }
            })
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('users-container');
                let html = `
                <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                    <tr style="background: #f5f5f5;">
                        <th style="padding: 8px; border: 1px solid #ddd;">用户ID</th>
                        <th style="padding: 8px; border: 1px solid #ddd;">用户名</th>
                        <th style="padding: 8px; border: 1px solid #ddd;">角色</th>
                        <th style="padding: 8px; border: 1px solid #ddd;">操作</th>
                    </tr>`;

                data.forEach(sub => {
                    html += `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;">${sub.uid}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;"><a href="/user/${sub.username}">${sub.username}</a></td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${sub.role}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">
                            <button class="danger-btn" onclick="confirmDelete(${sub.uid})">删除</button>
                        </td>
                    </tr>`;
                });

                html += '</table>';
                container.innerHTML = html;
            })
            .catch(error => {
                console.error('加载失败:', error);
            });
        }
        // 页面加载完成后执行
        window.onload = function() {
            checkLoginStatus();
            loadUsers();
        };
    </script>
    <style>
        .danger-btn {
            background-color: #dc3545;  
            color: #fff;
            border: none;
            padding: 5px 5px;
            border-radius: 5px;
            cursor: pointer;
        }        
        .danger-btn:hover {
            background-color: #c82333;  
            color: #fff;
            border: none;
            padding: 5px 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .primary-btn {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 5px 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .primary-btn {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 5px 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .primary-btn:hover {
            background-color: #0056b3;
            color: #fff;
            border: none;
            padding: 5px 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .warning-btn {
            background-color: #ffc107;
            color: #fff;
            border: none;
            padding: 5px 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .warning-btn:hover {
            background-color: #e0a800;
            color: #fff;
            border: none;
            padding: 5px 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .success-btn {
            background-color: #28a745;
            color: #fff;
            border: none;
            padding: 5px 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .success-btn:hover {
            background-color: #218838;
            color: #fff;
            border: none;
            padding: 5px 5px;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>    <style>
        .danger-btn {
            background-color: #dc3545;  
            color: #fff;
            border: none;
            padding: 5px 5px;
            border-radius: 5px;
            cursor: pointer;
        }        
        .danger-btn:hover {
            background-color: #c82333;  
            color: #fff;
            border: none;
            padding: 5px 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .primary-btn {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 5px 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .primary-btn {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 5px 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .primary-btn:hover {
            background-color: #0056b3;
            color: #fff;
            border: none;
            padding: 5px 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .warning-btn {
            background-color: #ffc107;
            color: #fff;
            border: none;
            padding: 5px 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .warning-btn:hover {
            background-color: #e0a800;
            color: #fff;
            border: none;
            padding: 5px 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .success-btn {
            background-color: #28a745;
            color: #fff;
            border: none;
            padding: 5px 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .success-btn:hover {
            background-color: #218838;
            color: #fff;
            border: none;
            padding: 5px 5px;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- 顶部导航 -->
    <header style="background: linear-gradient(to bottom, #ebf1f6 0%,#abd3ee 50%,#89c3eb 51%,#d5ebfb 100%);height: 50px;">
        <div style="display: inline-block; margin-left: 20px;line-height: 50px;"><a href="/home">返回首页</a></div>
        <div style="display: inline-block; margin-left: 20px;line-height: 50px;"><a href="/admin">仪表盘</a></div>
        <div style="display: inline-block; margin-left: 20px;line-height: 50px;"><a href="/admin/users">用户管理</a></div>
    </header>

    <!-- 用户信息 -->
    <div id="user-info" style="display: none;">
        <p>您已登录，角色: <span id="role-display"></span>，用户名: <span id="username-display"></span></p>
        <button class="danger-btn"  onclick="localStorage.removeItem('token'); checkLoginStatus();">退出登录</button>
    </div>

    <!-- 用户列表 -->
    <section style="margin: 20px;">
        <h2>用户列表</h2>
        <div id="users-container">
            <p>加载中...</p>
        </div>
        <div>
            <p style="display: inline-block;">每页用户数：</p>
            <input type="number" id="count" value="10" placeholder="每页用户数" style="margin-left: 20px;">
            <p style="display: inline-block;margin-left: 20px;">页码：</p>
            <input type="number" id="page" value="1" placeholder="页码" style="margin-left: 20px;">
            <button class="primary-btn" onclick="loadUsers()">查询</button>
        </div>
    </section>
    <dialog id="delete-dialog">
        <form method="dialog">
            <p>确认删除用户 <span id="delete-uid"></span> 吗？</p>
            <button class="danger-btn" type="submit" onclick="deleteUser(getElementById('delete-uid').textContent)">删除</button>
            <button class="primary-btn" type="button" onclick="closeDeleteDialog()">取消</button>
        </form>
    </dialog>
</body>
</html>